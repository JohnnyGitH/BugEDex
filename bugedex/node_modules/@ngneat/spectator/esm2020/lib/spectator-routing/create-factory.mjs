import { NgZone } from '@angular/core';
import { TestBed, waitForAsync } from '@angular/core/testing';
import { ActivatedRoute, Router } from '@angular/router';
import { setProps } from '../internals/query';
import * as customMatchers from '../matchers';
import { overrideComponentIfProviderOverridesSpecified, overrideModules } from '../spectator/create-factory';
import { addMatchers } from '../core';
import { isType } from '../types';
import { ActivatedRouteStub } from './activated-route-stub';
import { initialRoutingModule } from './initial-module';
import { getRoutingDefaultOptions } from './options';
import { SpectatorRouting } from './spectator-routing';
/**
 * @publicApi
 */
export function createRoutingFactory(typeOrOptions) {
    const options = isType(typeOrOptions)
        ? getRoutingDefaultOptions({ component: typeOrOptions })
        : getRoutingDefaultOptions(typeOrOptions);
    const moduleMetadata = initialRoutingModule(options);
    beforeEach(waitForAsync(() => {
        addMatchers(customMatchers);
        TestBed.configureTestingModule(moduleMetadata);
        overrideModules(options);
        overrideComponentIfProviderOverridesSpecified(options);
        TestBed.compileComponents();
    }));
    return (overrides) => {
        const defaults = {
            props: {},
            detectChanges: true,
            providers: []
        };
        const { detectChanges, props, providers } = { ...defaults, ...overrides };
        if (providers && providers.length) {
            providers.forEach((provider) => {
                TestBed.overrideProvider(provider.provide, provider);
            });
        }
        const { params, queryParams, data, fragment, url, root, parent, children, firstChild } = { ...options, ...overrides };
        TestBed.overrideProvider(ActivatedRoute, {
            useValue: new ActivatedRouteStub({ params, queryParams, data, fragment, url, root, parent, children, firstChild })
        });
        const ngZone = TestBed.inject ? TestBed.inject(NgZone) : TestBed.get(NgZone);
        return ngZone.run(() => {
            const spectator = createSpectatorRouting(options, props);
            spectator.router.initialNavigation();
            if (options.detectChanges && detectChanges) {
                spectator.detectChanges();
            }
            return spectator;
        });
    };
}
function createSpectatorRouting(options, props) {
    const fixture = TestBed.createComponent(options.component);
    const debugElement = fixture.debugElement;
    const component = setProps(fixture.componentInstance, props);
    /**
     * Back compatibility, angular under 9 version doesnt have a inject function
     */
    if (!TestBed.inject) {
        return new SpectatorRouting(fixture, debugElement, component, TestBed.get(Router), TestBed.get(ActivatedRoute));
    }
    return new SpectatorRouting(fixture, debugElement, component, TestBed.inject(Router), TestBed.inject(ActivatedRoute));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zcGVjdGF0b3Ivc3JjL2xpYi9zcGVjdGF0b3Itcm91dGluZy9jcmVhdGUtZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWtCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzlELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFekQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlDLE9BQU8sS0FBSyxjQUFjLE1BQU0sYUFBYSxDQUFDO0FBQzlDLE9BQU8sRUFBc0IsNkNBQTZDLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDakksT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN0QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRWxDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hELE9BQU8sRUFBRSx3QkFBd0IsRUFBMkIsTUFBTSxXQUFXLENBQUM7QUFFOUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFhdkQ7O0dBRUc7QUFDSCxNQUFNLFVBQVUsb0JBQW9CLENBQUksYUFBbUQ7SUFDekYsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQztRQUNuQyxDQUFDLENBQUMsd0JBQXdCLENBQUksRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLENBQUM7UUFDM0QsQ0FBQyxDQUFDLHdCQUF3QixDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBRTVDLE1BQU0sY0FBYyxHQUFHLG9CQUFvQixDQUFJLE9BQU8sQ0FBQyxDQUFDO0lBRXhELFVBQVUsQ0FDUixZQUFZLENBQUMsR0FBRyxFQUFFO1FBQ2hCLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUM1QixPQUFPLENBQUMsc0JBQXNCLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFL0MsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXpCLDZDQUE2QyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXZELE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQzlCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFFRixPQUFPLENBQUMsU0FBd0MsRUFBRSxFQUFFO1FBQ2xELE1BQU0sUUFBUSxHQUFpQztZQUM3QyxLQUFLLEVBQUUsRUFBRTtZQUNULGFBQWEsRUFBRSxJQUFJO1lBQ25CLFNBQVMsRUFBRSxFQUFFO1NBQ2QsQ0FBQztRQUVGLE1BQU0sRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsR0FBRyxRQUFRLEVBQUUsR0FBRyxTQUFTLEVBQUUsQ0FBQztRQUUxRSxJQUFJLFNBQVMsSUFBSSxTQUFTLENBQUMsTUFBTSxFQUFFO1lBQ2pDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFrQixFQUFFLEVBQUU7Z0JBQ3ZDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBRSxRQUFnQixDQUFDLE9BQU8sRUFBRSxRQUFlLENBQUMsQ0FBQztZQUN2RSxDQUFDLENBQUMsQ0FBQztTQUNKO1FBRUQsTUFBTSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxHQUFHLE9BQU8sRUFBRSxHQUFHLFNBQVMsRUFBRSxDQUFDO1FBRXRILE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUU7WUFDdkMsUUFBUSxFQUFFLElBQUksa0JBQWtCLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxDQUFDO1NBQ25ILENBQUMsQ0FBQztRQUNILE1BQU0sTUFBTSxHQUFTLE9BQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFcEYsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRTtZQUNyQixNQUFNLFNBQVMsR0FBRyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFekQsU0FBUyxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBRXJDLElBQUksT0FBTyxDQUFDLGFBQWEsSUFBSSxhQUFhLEVBQUU7Z0JBQzFDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUMzQjtZQUVELE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsc0JBQXNCLENBQUksT0FBNkMsRUFBRSxLQUFrQjtJQUNsRyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMzRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDO0lBRTFDLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFN0Q7O09BRUc7SUFDSCxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtRQUNuQixPQUFPLElBQUksZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7S0FDakg7SUFFRCxPQUFPLElBQUksZ0JBQWdCLENBQ3pCLE9BQU8sRUFDUCxZQUFZLEVBQ1osU0FBUyxFQUNULE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQ3RCLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFrQyxDQUNoRSxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3ZpZGVyLCBUeXBlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRlc3RCZWQsIHdhaXRGb3JBc3luYyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgc2V0UHJvcHMgfSBmcm9tICcuLi9pbnRlcm5hbHMvcXVlcnknO1xuaW1wb3J0ICogYXMgY3VzdG9tTWF0Y2hlcnMgZnJvbSAnLi4vbWF0Y2hlcnMnO1xuaW1wb3J0IHsgU3BlY3RhdG9yT3ZlcnJpZGVzLCBvdmVycmlkZUNvbXBvbmVudElmUHJvdmlkZXJPdmVycmlkZXNTcGVjaWZpZWQsIG92ZXJyaWRlTW9kdWxlcyB9IGZyb20gJy4uL3NwZWN0YXRvci9jcmVhdGUtZmFjdG9yeSc7XG5pbXBvcnQgeyBhZGRNYXRjaGVycyB9IGZyb20gJy4uL2NvcmUnO1xuaW1wb3J0IHsgaXNUeXBlIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZVN0dWIgfSBmcm9tICcuL2FjdGl2YXRlZC1yb3V0ZS1zdHViJztcbmltcG9ydCB7IGluaXRpYWxSb3V0aW5nTW9kdWxlIH0gZnJvbSAnLi9pbml0aWFsLW1vZHVsZSc7XG5pbXBvcnQgeyBnZXRSb3V0aW5nRGVmYXVsdE9wdGlvbnMsIFNwZWN0YXRvclJvdXRpbmdPcHRpb25zIH0gZnJvbSAnLi9vcHRpb25zJztcbmltcG9ydCB7IFJvdXRlT3B0aW9ucyB9IGZyb20gJy4vcm91dGUtb3B0aW9ucyc7XG5pbXBvcnQgeyBTcGVjdGF0b3JSb3V0aW5nIH0gZnJvbSAnLi9zcGVjdGF0b3Itcm91dGluZyc7XG5pbXBvcnQgeyBTcHlPYmplY3QgfSBmcm9tICcuLi9tb2NrJztcblxuLyoqXG4gKiBAcHVibGljQXBpXG4gKi9cbmV4cG9ydCB0eXBlIFNwZWN0YXRvclJvdXRpbmdPdmVycmlkZXM8Qz4gPSBTcGVjdGF0b3JPdmVycmlkZXM8Qz4gJiBSb3V0ZU9wdGlvbnM7XG5cbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgdHlwZSBTcGVjdGF0b3JSb3V0aW5nRmFjdG9yeTxDPiA9IChvcHRpb25zPzogU3BlY3RhdG9yUm91dGluZ092ZXJyaWRlczxDPikgPT4gU3BlY3RhdG9yUm91dGluZzxDPjtcblxuLyoqXG4gKiBAcHVibGljQXBpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSb3V0aW5nRmFjdG9yeTxDPih0eXBlT3JPcHRpb25zOiBUeXBlPEM+IHwgU3BlY3RhdG9yUm91dGluZ09wdGlvbnM8Qz4pOiBTcGVjdGF0b3JSb3V0aW5nRmFjdG9yeTxDPiB7XG4gIGNvbnN0IG9wdGlvbnMgPSBpc1R5cGUodHlwZU9yT3B0aW9ucylcbiAgICA/IGdldFJvdXRpbmdEZWZhdWx0T3B0aW9uczxDPih7IGNvbXBvbmVudDogdHlwZU9yT3B0aW9ucyB9KVxuICAgIDogZ2V0Um91dGluZ0RlZmF1bHRPcHRpb25zKHR5cGVPck9wdGlvbnMpO1xuXG4gIGNvbnN0IG1vZHVsZU1ldGFkYXRhID0gaW5pdGlhbFJvdXRpbmdNb2R1bGU8Qz4ob3B0aW9ucyk7XG5cbiAgYmVmb3JlRWFjaChcbiAgICB3YWl0Rm9yQXN5bmMoKCkgPT4ge1xuICAgICAgYWRkTWF0Y2hlcnMoY3VzdG9tTWF0Y2hlcnMpO1xuICAgICAgVGVzdEJlZC5jb25maWd1cmVUZXN0aW5nTW9kdWxlKG1vZHVsZU1ldGFkYXRhKTtcblxuICAgICAgb3ZlcnJpZGVNb2R1bGVzKG9wdGlvbnMpO1xuXG4gICAgICBvdmVycmlkZUNvbXBvbmVudElmUHJvdmlkZXJPdmVycmlkZXNTcGVjaWZpZWQob3B0aW9ucyk7XG5cbiAgICAgIFRlc3RCZWQuY29tcGlsZUNvbXBvbmVudHMoKTtcbiAgICB9KVxuICApO1xuXG4gIHJldHVybiAob3ZlcnJpZGVzPzogU3BlY3RhdG9yUm91dGluZ092ZXJyaWRlczxDPikgPT4ge1xuICAgIGNvbnN0IGRlZmF1bHRzOiBTcGVjdGF0b3JSb3V0aW5nT3ZlcnJpZGVzPEM+ID0ge1xuICAgICAgcHJvcHM6IHt9LFxuICAgICAgZGV0ZWN0Q2hhbmdlczogdHJ1ZSxcbiAgICAgIHByb3ZpZGVyczogW11cbiAgICB9O1xuXG4gICAgY29uc3QgeyBkZXRlY3RDaGFuZ2VzLCBwcm9wcywgcHJvdmlkZXJzIH0gPSB7IC4uLmRlZmF1bHRzLCAuLi5vdmVycmlkZXMgfTtcblxuICAgIGlmIChwcm92aWRlcnMgJiYgcHJvdmlkZXJzLmxlbmd0aCkge1xuICAgICAgcHJvdmlkZXJzLmZvckVhY2goKHByb3ZpZGVyOiBQcm92aWRlcikgPT4ge1xuICAgICAgICBUZXN0QmVkLm92ZXJyaWRlUHJvdmlkZXIoKHByb3ZpZGVyIGFzIGFueSkucHJvdmlkZSwgcHJvdmlkZXIgYXMgYW55KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgcGFyYW1zLCBxdWVyeVBhcmFtcywgZGF0YSwgZnJhZ21lbnQsIHVybCwgcm9vdCwgcGFyZW50LCBjaGlsZHJlbiwgZmlyc3RDaGlsZCB9ID0geyAuLi5vcHRpb25zLCAuLi5vdmVycmlkZXMgfTtcblxuICAgIFRlc3RCZWQub3ZlcnJpZGVQcm92aWRlcihBY3RpdmF0ZWRSb3V0ZSwge1xuICAgICAgdXNlVmFsdWU6IG5ldyBBY3RpdmF0ZWRSb3V0ZVN0dWIoeyBwYXJhbXMsIHF1ZXJ5UGFyYW1zLCBkYXRhLCBmcmFnbWVudCwgdXJsLCByb290LCBwYXJlbnQsIGNoaWxkcmVuLCBmaXJzdENoaWxkIH0pXG4gICAgfSk7XG4gICAgY29uc3Qgbmdab25lID0gKDxhbnk+VGVzdEJlZCkuaW5qZWN0ID8gVGVzdEJlZC5pbmplY3QoTmdab25lKSA6IFRlc3RCZWQuZ2V0KE5nWm9uZSk7XG5cbiAgICByZXR1cm4gbmdab25lLnJ1bigoKSA9PiB7XG4gICAgICBjb25zdCBzcGVjdGF0b3IgPSBjcmVhdGVTcGVjdGF0b3JSb3V0aW5nKG9wdGlvbnMsIHByb3BzKTtcblxuICAgICAgc3BlY3RhdG9yLnJvdXRlci5pbml0aWFsTmF2aWdhdGlvbigpO1xuXG4gICAgICBpZiAob3B0aW9ucy5kZXRlY3RDaGFuZ2VzICYmIGRldGVjdENoYW5nZXMpIHtcbiAgICAgICAgc3BlY3RhdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHNwZWN0YXRvcjtcbiAgICB9KTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlU3BlY3RhdG9yUm91dGluZzxDPihvcHRpb25zOiBSZXF1aXJlZDxTcGVjdGF0b3JSb3V0aW5nT3B0aW9uczxDPj4sIHByb3BzPzogUGFydGlhbDxDPik6IFNwZWN0YXRvclJvdXRpbmc8Qz4ge1xuICBjb25zdCBmaXh0dXJlID0gVGVzdEJlZC5jcmVhdGVDb21wb25lbnQob3B0aW9ucy5jb21wb25lbnQpO1xuICBjb25zdCBkZWJ1Z0VsZW1lbnQgPSBmaXh0dXJlLmRlYnVnRWxlbWVudDtcblxuICBjb25zdCBjb21wb25lbnQgPSBzZXRQcm9wcyhmaXh0dXJlLmNvbXBvbmVudEluc3RhbmNlLCBwcm9wcyk7XG5cbiAgLyoqXG4gICAqIEJhY2sgY29tcGF0aWJpbGl0eSwgYW5ndWxhciB1bmRlciA5IHZlcnNpb24gZG9lc250IGhhdmUgYSBpbmplY3QgZnVuY3Rpb25cbiAgICovXG4gIGlmICghVGVzdEJlZC5pbmplY3QpIHtcbiAgICByZXR1cm4gbmV3IFNwZWN0YXRvclJvdXRpbmcoZml4dHVyZSwgZGVidWdFbGVtZW50LCBjb21wb25lbnQsIFRlc3RCZWQuZ2V0KFJvdXRlciksIFRlc3RCZWQuZ2V0KEFjdGl2YXRlZFJvdXRlKSk7XG4gIH1cblxuICByZXR1cm4gbmV3IFNwZWN0YXRvclJvdXRpbmcoXG4gICAgZml4dHVyZSxcbiAgICBkZWJ1Z0VsZW1lbnQsXG4gICAgY29tcG9uZW50LFxuICAgIFRlc3RCZWQuaW5qZWN0KFJvdXRlciksXG4gICAgVGVzdEJlZC5pbmplY3QoQWN0aXZhdGVkUm91dGUpIGFzIFNweU9iamVjdDxBY3RpdmF0ZWRSb3V0ZVN0dWI+XG4gICk7XG59XG4iXX0=