import { TestBed, waitForAsync } from '@angular/core/testing';
import { By } from '@angular/platform-browser';
import { BrowserDynamicTestingModule } from '@angular/platform-browser-dynamic/testing';
import { setProps } from '../internals/query';
import * as customMatchers from '../matchers';
import { addMatchers } from '../core';
import { isType } from '../types';
import { nodeByDirective } from '../internals/node-by-directive';
import { initialSpectatorDirectiveModule } from './initial-module';
import { getSpectatorDirectiveDefaultOptions } from './options';
import { SpectatorDirective } from './spectator-directive';
import { overrideModules } from '../spectator/create-factory';
export function createDirectiveFactory(typeOrOptions) {
    const options = isType(typeOrOptions)
        ? getSpectatorDirectiveDefaultOptions({ directive: typeOrOptions })
        : getSpectatorDirectiveDefaultOptions(typeOrOptions);
    const moduleMetadata = initialSpectatorDirectiveModule(options);
    beforeEach(waitForAsync(() => {
        addMatchers(customMatchers);
        TestBed.configureTestingModule(moduleMetadata);
        overrideModules(options);
    }));
    return (template, overrides) => {
        const defaults = {
            props: {},
            hostProps: {},
            detectChanges: true,
            providers: []
        };
        const { detectChanges, props, hostProps, providers } = { ...defaults, ...overrides };
        if (providers && providers.length) {
            providers.forEach((provider) => {
                TestBed.overrideProvider(provider.provide, provider);
            });
        }
        TestBed.overrideModule(BrowserDynamicTestingModule, {
            set: {
                entryComponents: moduleMetadata.entryComponents
            }
        }).overrideComponent(options.host, {
            set: { template: template || options.template }
        });
        if (options.directiveProviders.length || options.directiveMocks.length) {
            TestBed.overrideDirective(options.directive, {
                set: { providers: [...options.directiveProviders, ...options.directiveMocks.map(p => options.mockProvider(p))] }
            });
        }
        const spectator = createSpectatorDirective(options, props, hostProps);
        if (options.detectChanges && detectChanges) {
            spectator.detectChanges();
        }
        return spectator;
    };
}
function createSpectatorDirective(options, props, hostProps) {
    const hostFixture = TestBed.createComponent(options.host);
    const debugElement = hostFixture.debugElement.query(By.directive(options.directive)) || hostFixture.debugElement;
    const debugNode = hostFixture.debugElement.queryAllNodes(nodeByDirective(options.directive))[0];
    if (!debugNode) {
        throw new Error(`Cannot find directive ${options.directive} in host template ðŸ˜”`);
    }
    const hostComponent = setProps(hostFixture.componentInstance, hostProps);
    const directive = setProps(debugNode.injector.get(options.directive), props);
    return new SpectatorDirective(hostComponent, hostFixture, hostFixture.debugElement, directive, debugElement.nativeElement);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zcGVjdGF0b3Ivc3JjL2xpYi9zcGVjdGF0b3ItZGlyZWN0aXZlL2NyZWF0ZS1mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDOUQsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQy9DLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBRXhGLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEtBQUssY0FBYyxNQUFNLGFBQWEsQ0FBQztBQUM5QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFHbEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRWpFLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxtQ0FBbUMsRUFBNkIsTUFBTSxXQUFXLENBQUM7QUFDM0YsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBd0M5RCxNQUFNLFVBQVUsc0JBQXNCLENBQ3BDLGFBQXdEO0lBRXhELE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUM7UUFDbkMsQ0FBQyxDQUFDLG1DQUFtQyxDQUFPLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxDQUFDO1FBQ3pFLENBQUMsQ0FBQyxtQ0FBbUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUV2RCxNQUFNLGNBQWMsR0FBRywrQkFBK0Is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QUMsV0FBVyxDQUFDLGlCQUFpQixFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3pFLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFN0UsT0FBTyxJQUFJLGtCQUFrQixDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsV0FBVyxDQUFDLFlBQVksRUFBRSxTQUFTLEVBQUUsWUFBWSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzdILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcm92aWRlciwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGVzdEJlZCwgd2FpdEZvckFzeW5jIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS90ZXN0aW5nJztcbmltcG9ydCB7IEJ5IH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQgeyBCcm93c2VyRHluYW1pY1Rlc3RpbmdNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyLWR5bmFtaWMvdGVzdGluZyc7XG5cbmltcG9ydCB7IHNldFByb3BzIH0gZnJvbSAnLi4vaW50ZXJuYWxzL3F1ZXJ5JztcbmltcG9ydCAqIGFzIGN1c3RvbU1hdGNoZXJzIGZyb20gJy4uL21hdGNoZXJzJztcbmltcG9ydCB7IGFkZE1hdGNoZXJzIH0gZnJvbSAnLi4vY29yZSc7XG5pbXBvcnQgeyBpc1R5cGUgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBIb3N0Q29tcG9uZW50IH0gZnJvbSAnLi4vc3BlY3RhdG9yLWhvc3QvaG9zdC1jb21wb25lbnQnO1xuaW1wb3J0IHsgQmFzZVNwZWN0YXRvck92ZXJyaWRlcyB9IGZyb20gJy4uL2Jhc2Uvb3B0aW9ucyc7XG5pbXBvcnQgeyBub2RlQnlEaXJlY3RpdmUgfSBmcm9tICcuLi9pbnRlcm5hbHMvbm9kZS1ieS1kaXJlY3RpdmUnO1xuXG5pbXBvcnQgeyBpbml0aWFsU3BlY3RhdG9yRGlyZWN0aXZlTW9kdWxlIH0gZnJvbSAnLi9pbml0aWFsLW1vZHVsZSc7XG5pbXBvcnQgeyBnZXRTcGVjdGF0b3JEaXJlY3RpdmVEZWZhdWx0T3B0aW9ucywgU3BlY3RhdG9yRGlyZWN0aXZlT3B0aW9ucyB9IGZyb20gJy4vb3B0aW9ucyc7XG5pbXBvcnQgeyBTcGVjdGF0b3JEaXJlY3RpdmUgfSBmcm9tICcuL3NwZWN0YXRvci1kaXJlY3RpdmUnO1xuaW1wb3J0IHsgb3ZlcnJpZGVNb2R1bGVzIH0gZnJvbSAnLi4vc3BlY3RhdG9yL2NyZWF0ZS1mYWN0b3J5JztcblxuLyoqXG4gKiBAcHVibGljQXBpXG4gKi9cbmV4cG9ydCB0eXBlIFNwZWN0YXRvckRpcmVjdGl2ZUZhY3Rvcnk8RCwgSD4gPSA8SFA+KFxuICB0ZW1wbGF0ZTogc3RyaW5nLFxuICBvdmVycmlkZXM/OiBTcGVjdGF0b3JEaXJlY3RpdmVPdmVycmlkZXM8RCwgSCwgSFA+XG4pID0+IFNwZWN0YXRvckRpcmVjdGl2ZTxELCBIICYgKEhvc3RDb21wb25lbnQgZXh0ZW5kcyBIID8gSFAgOiB1bmtub3duKT47XG5cbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgdHlwZSBQcmVzZXRTcGVjdGF0b3JEaXJlY3RpdmVGYWN0b3J5PEQsIEg+ID0gPEhQPihcbiAgdGVtcGxhdGU/OiBzdHJpbmcsXG4gIG92ZXJyaWRlcz86IFNwZWN0YXRvckRpcmVjdGl2ZU92ZXJyaWRlczxELCBILCBIUD5cbikgPT4gU3BlY3RhdG9yRGlyZWN0aXZlPEQsIEggJiAoSG9zdENvbXBvbmVudCBleHRlbmRzIEggPyBIUCA6IHVua25vd24pPjtcblxuLyoqXG4gKiBAcHVibGljQXBpXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU3BlY3RhdG9yRGlyZWN0aXZlT3ZlcnJpZGVzPEQsIEgsIEhQPiBleHRlbmRzIEJhc2VTcGVjdGF0b3JPdmVycmlkZXMge1xuICBkZXRlY3RDaGFuZ2VzPzogYm9vbGVhbjtcbiAgcHJvcHM/OiBQYXJ0aWFsPEQ+O1xuICBob3N0UHJvcHM/OiBIb3N0Q29tcG9uZW50IGV4dGVuZHMgSCA/IEhQIDogUGFydGlhbDxIPjtcbiAgZGlyZWN0aXZlUHJvdmlkZXJzPzogUHJvdmlkZXJbXTtcbn1cblxuLyoqXG4gKiBAcHVibGljQXBpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVEaXJlY3RpdmVGYWN0b3J5PEQsIEggPSBIb3N0Q29tcG9uZW50PihcbiAgb3B0aW9uczogU3BlY3RhdG9yRGlyZWN0aXZlT3B0aW9uczxELCBIPiAmIHsgdGVtcGxhdGU6IHN0cmluZyB9XG4pOiBQcmVzZXRTcGVjdGF0b3JEaXJlY3RpdmVGYWN0b3J5PEQsIEg+O1xuLyoqXG4gKiBAcHVibGljQXBpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVEaXJlY3RpdmVGYWN0b3J5PEQsIEggPSBIb3N0Q29tcG9uZW50PihcbiAgdHlwZU9yT3B0aW9uczogVHlwZTxEPiB8IFNwZWN0YXRvckRpcmVjdGl2ZU9wdGlvbnM8RCwgSD5cbik6IFNwZWN0YXRvckRpcmVjdGl2ZUZhY3Rvcnk8RCwgSD47XG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRGlyZWN0aXZlRmFjdG9yeTxELCBIID0gSG9zdENvbXBvbmVudD4oXG4gIHR5cGVPck9wdGlvbnM6IFR5cGU8RD4gfCBTcGVjdGF0b3JEaXJlY3RpdmVPcHRpb25zPEQsIEg+XG4pOiBTcGVjdGF0b3JEaXJlY3RpdmVGYWN0b3J5PEQsIEg+IHtcbiAgY29uc3Qgb3B0aW9ucyA9IGlzVHlwZSh0eXBlT3JPcHRpb25zKVxuICAgID8gZ2V0U3BlY3RhdG9yRGlyZWN0aXZlRGVmYXVsdE9wdGlvbnM8RCwgSD4oeyBkaXJlY3RpdmU6IHR5cGVPck9wdGlvbnMgfSlcbiAgICA6IGdldFNwZWN0YXRvckRpcmVjdGl2ZURlZmF1bHRPcHRpb25zKHR5cGVPck9wdGlvbnMpO1xuXG4gIGNvbnN0IG1vZHVsZU1ldGFkYXRhID0gaW5pdGlhbFNwZWN0YXRvckRpcmVjdGl2ZU1vZHVsZTxELCBIPihvcHRpb25zKTtcblxuICBiZWZvcmVFYWNoKFxuICAgIHdhaXRGb3JBc3luYygoKSA9PiB7XG4gICAgICBhZGRNYXRjaGVycyhjdXN0b21NYXRjaGVycyk7XG4gICAgICBUZXN0QmVkLmNvbmZpZ3VyZVRlc3RpbmdNb2R1bGUobW9kdWxlTWV0YWRhdGEpO1xuICAgICAgb3ZlcnJpZGVNb2R1bGVzKG9wdGlvbnMpO1xuICAgIH0pXG4gICk7XG5cbiAgcmV0dXJuIDxIUD4odGVtcGxhdGU/OiBzdHJpbmcsIG92ZXJyaWRlcz86IFNwZWN0YXRvckRpcmVjdGl2ZU92ZXJyaWRlczxELCBILCBIUD4pID0+IHtcbiAgICBjb25zdCBkZWZhdWx0czogU3BlY3RhdG9yRGlyZWN0aXZlT3ZlcnJpZGVzPEQsIEgsIEhQPiA9IHtcbiAgICAgIHByb3BzOiB7fSxcbiAgICAgIGhvc3RQcm9wczoge30gYXMgYW55LFxuICAgICAgZGV0ZWN0Q2hhbmdlczogdHJ1ZSxcbiAgICAgIHByb3ZpZGVyczogW11cbiAgICB9O1xuICAgIGNvbnN0IHsgZGV0ZWN0Q2hhbmdlcywgcHJvcHMsIGhvc3RQcm9wcywgcHJvdmlkZXJzIH0gPSB7IC4uLmRlZmF1bHRzLCAuLi5vdmVycmlkZXMgfTtcblxuICAgIGlmIChwcm92aWRlcnMgJiYgcHJvdmlkZXJzLmxlbmd0aCkge1xuICAgICAgcHJvdmlkZXJzLmZvckVhY2goKHByb3ZpZGVyOiBQcm92aWRlcikgPT4ge1xuICAgICAgICBUZXN0QmVkLm92ZXJyaWRlUHJvdmlkZXIoKHByb3ZpZGVyIGFzIGFueSkucHJvdmlkZSwgcHJvdmlkZXIgYXMgYW55KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIFRlc3RCZWQub3ZlcnJpZGVNb2R1bGUoQnJvd3NlckR5bmFtaWNUZXN0aW5nTW9kdWxlLCB7XG4gICAgICBzZXQ6IHtcbiAgICAgICAgZW50cnlDb21wb25lbnRzOiBtb2R1bGVNZXRhZGF0YS5lbnRyeUNvbXBvbmVudHNcbiAgICAgIH1cbiAgICB9KS5vdmVycmlkZUNvbXBvbmVudChvcHRpb25zLmhvc3QsIHtcbiAgICAgIHNldDogeyB0ZW1wbGF0ZTogdGVtcGxhdGUgfHwgb3B0aW9ucy50ZW1wbGF0ZSB9XG4gICAgfSk7XG5cbiAgICBpZiAob3B0aW9ucy5kaXJlY3RpdmVQcm92aWRlcnMubGVuZ3RoIHx8IG9wdGlvbnMuZGlyZWN0aXZlTW9ja3MubGVuZ3RoKSB7XG4gICAgICBUZXN0QmVkLm92ZXJyaWRlRGlyZWN0aXZlKG9wdGlvbnMuZGlyZWN0aXZlLCB7XG4gICAgICAgIHNldDogeyBwcm92aWRlcnM6IFsuLi5vcHRpb25zLmRpcmVjdGl2ZVByb3ZpZGVycywgLi4ub3B0aW9ucy5kaXJlY3RpdmVNb2Nrcy5tYXAocCA9PiBvcHRpb25zLm1vY2tQcm92aWRlcihwKSldIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHNwZWN0YXRvciA9IGNyZWF0ZVNwZWN0YXRvckRpcmVjdGl2ZShvcHRpb25zLCBwcm9wcywgaG9zdFByb3BzKTtcblxuICAgIGlmIChvcHRpb25zLmRldGVjdENoYW5nZXMgJiYgZGV0ZWN0Q2hhbmdlcykge1xuICAgICAgc3BlY3RhdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3BlY3RhdG9yO1xuICB9O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVTcGVjdGF0b3JEaXJlY3RpdmU8RCwgSCwgSFA+KFxuICBvcHRpb25zOiBSZXF1aXJlZDxTcGVjdGF0b3JEaXJlY3RpdmVPcHRpb25zPEQsIEg+PixcbiAgcHJvcHM/OiBQYXJ0aWFsPEQ+LFxuICBob3N0UHJvcHM/OiBIUFxuKTogU3BlY3RhdG9yRGlyZWN0aXZlPEQsIEggJiBIUD4ge1xuICBjb25zdCBob3N0Rml4dHVyZSA9IFRlc3RCZWQuY3JlYXRlQ29tcG9uZW50KG9wdGlvbnMuaG9zdCk7XG4gIGNvbnN0IGRlYnVnRWxlbWVudCA9IGhvc3RGaXh0dXJlLmRlYnVnRWxlbWVudC5xdWVyeShCeS5kaXJlY3RpdmUob3B0aW9ucy5kaXJlY3RpdmUpKSB8fCBob3N0Rml4dHVyZS5kZWJ1Z0VsZW1lbnQ7XG4gIGNvbnN0IGRlYnVnTm9kZSA9IGhvc3RGaXh0dXJlLmRlYnVnRWxlbWVudC5xdWVyeUFsbE5vZGVzKG5vZGVCeURpcmVjdGl2ZShvcHRpb25zLmRpcmVjdGl2ZSkpWzBdO1xuXG4gIGlmICghZGVidWdOb2RlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZmluZCBkaXJlY3RpdmUgJHtvcHRpb25zLmRpcmVjdGl2ZX0gaW4gaG9zdCB0ZW1wbGF0ZSDwn5iUYCk7XG4gIH1cblxuICBjb25zdCBob3N0Q29tcG9uZW50ID0gc2V0UHJvcHMoaG9zdEZpeHR1cmUuY29tcG9uZW50SW5zdGFuY2UsIGhvc3RQcm9wcyk7XG4gIGNvbnN0IGRpcmVjdGl2ZSA9IHNldFByb3BzKGRlYnVnTm9kZS5pbmplY3Rvci5nZXQob3B0aW9ucy5kaXJlY3RpdmUpLCBwcm9wcyk7XG5cbiAgcmV0dXJuIG5ldyBTcGVjdGF0b3JEaXJlY3RpdmUoaG9zdENvbXBvbmVudCwgaG9zdEZpeHR1cmUsIGhvc3RGaXh0dXJlLmRlYnVnRWxlbWVudCwgZGlyZWN0aXZlLCBkZWJ1Z0VsZW1lbnQubmF0aXZlRWxlbWVudCk7XG59XG4iXX0=