import { ChangeDetectorRef, DebugElement, ElementRef } from '@angular/core';
import { Observable } from 'rxjs';
import { tick } from '@angular/core/testing';
import { By } from '@angular/platform-browser';
import { DOMSelector } from '../dom-selectors';
import { isString } from '../types';
import { getChildren, setProps } from '../internals/query';
import { patchElementFocus } from '../internals/element-focus';
import { createMouseEvent } from '../event-creators';
import { dispatchFakeEvent, dispatchKeyboardEvent, dispatchMouseEvent, dispatchTouchEvent } from '../dispatch-events';
import { typeInElement } from '../type-in-element';
import { selectOption } from '../select-option';
import { BaseSpectator } from './base-spectator';
const KEY_UP = 'keyup';
/**
 * @internal
 */
export class DomSpectator extends BaseSpectator {
    constructor(fixture, debugElement, instance, element) {
        super();
        this.fixture = fixture;
        this.debugElement = debugElement;
        this.instance = instance;
        this.element = element;
    }
    inject(token) {
        return super.inject(token);
    }
    detectChanges() {
        this.fixture.detectChanges();
    }
    query(directiveOrSelector, options) {
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                return document.querySelector(directiveOrSelector);
            }
            if (directiveOrSelector instanceof DOMSelector) {
                return directiveOrSelector.execute(document)[0] || null;
            }
        }
        return getChildren(this.debugElement)(directiveOrSelector, options)[0] || null;
    }
    queryAll(directiveOrSelector, options) {
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                return Array.from(document.querySelectorAll(directiveOrSelector));
            }
            if (directiveOrSelector instanceof DOMSelector) {
                return directiveOrSelector.execute(document);
            }
        }
        return getChildren(this.debugElement)(directiveOrSelector, options);
    }
    queryLast(directiveOrSelector, options) {
        let result = [];
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                result = Array.from(document.querySelectorAll(directiveOrSelector));
            }
            if (directiveOrSelector instanceof DOMSelector) {
                result = directiveOrSelector.execute(document);
            }
        }
        else {
            result = getChildren(this.debugElement)(directiveOrSelector, options);
        }
        if (result && result.length) {
            return result[result.length - 1];
        }
        return null;
    }
    setInput(input, value) {
        setProps(this.instance, input, value, false);
        this.debugElement.injector.get(ChangeDetectorRef).detectChanges();
    }
    output(output) {
        const observable = this.instance[output];
        if (!(observable instanceof Observable)) {
            throw new Error(`${output} is not an @Output`);
        }
        return observable;
    }
    tick(millis) {
        tick(millis);
        this.detectChanges();
    }
    click(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot click: ${selector} is not a HTMLElement`);
        }
        element.click();
        this.detectChanges();
    }
    blur(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot blur: ${selector} is not a HTMLElement`);
        }
        patchElementFocus(element);
        element.blur();
        this.detectChanges();
    }
    focus(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot focus: ${selector} is not a HTMLElement`);
        }
        patchElementFocus(element);
        element.focus();
        this.detectChanges();
    }
    dispatchMouseEvent(selector = this.element, type, x = 0, y = 0, event = createMouseEvent(type, x, y)) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof Node)) {
            throw new Error(`Cannot dispatch mouse event: ${selector} is not a node`);
        }
        const dispatchedEvent = dispatchMouseEvent(element, type, x, y, event);
        this.detectChanges();
        return dispatchedEvent;
    }
    dispatchKeyboardEvent(selector = this.element, type, keyOrKeyCode, target) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof Node)) {
            throw new Error(`Cannot dispatch keyboard event: ${selector} is not a node`);
        }
        const event = dispatchKeyboardEvent(element, type, keyOrKeyCode, target);
        this.detectChanges();
        return event;
    }
    dispatchFakeEvent(selector = this.element, type, canBubble) {
        const event = dispatchFakeEvent(this.getNativeElement(selector), type, canBubble);
        this.detectChanges();
        return event;
    }
    triggerEventHandler(directiveOrSelector, eventName, eventObj, options) {
        const triggerDebugElement = this.getTriggerDebugElement(directiveOrSelector, options);
        if (!triggerDebugElement) {
            /* eslint-disable no-console */
            console.error(`${directiveOrSelector} does not exists`);
            return;
        }
        triggerDebugElement.triggerEventHandler(eventName, eventObj);
        this.detectChanges();
    }
    get keyboard() {
        return {
            pressKey: (key, selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, key);
            },
            pressEscape: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Escape', keyCode: 27 });
            },
            pressEnter: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Enter', keyCode: 13 });
            },
            pressTab: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Tab', keyCode: 9 });
            },
            pressBackspace: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Backspace', keyCode: 8 });
            },
        };
    }
    get mouse() {
        return {
            contextmenu: (selector = this.element) => {
                this.dispatchMouseEvent(selector, 'contextmenu');
            },
            dblclick: (selector = this.element) => {
                this.dispatchMouseEvent(selector, 'dblclick');
            },
        };
    }
    dispatchTouchEvent(selector = this.element, type, x = 0, y = 0) {
        dispatchTouchEvent(this.getNativeElement(selector), type, x, y);
        this.detectChanges();
    }
    typeInElement(value, selector = this.element) {
        typeInElement(value, this.getNativeElement(selector));
        this.detectChanges();
    }
    selectOption(selector = this.element, options, config = { emitEvents: true }) {
        if (!selector) {
            throw new Error(`Cannot find select: ${selector}`);
        }
        selectOption(options, this.getNativeElement(selector), config);
        this.detectChanges();
    }
    getNativeElement(selector) {
        let element;
        // Support global objects window and document
        if (selector === window || selector === document) {
            return selector;
        }
        if (isString(selector)) {
            const exists = this.debugElement.query(By.css(selector));
            if (exists) {
                element = exists.nativeElement;
            }
            else {
                /* eslint-disable no-console */
                console.error(`${selector} does not exists`);
            }
        }
        else if (selector instanceof DOMSelector) {
            element = selector.execute(document)[0] || null;
        }
        else {
            if (selector instanceof DebugElement || selector instanceof ElementRef) {
                element = selector.nativeElement;
            }
            else {
                element = selector;
            }
        }
        return element;
    }
    getTriggerDebugElement(directiveOrSelector, options) {
        const debugElement = options?.root ? this.getRootDebugElement() : this.debugElement;
        if (isString(directiveOrSelector)) {
            return debugElement.query(By.css(directiveOrSelector));
        }
        else if (directiveOrSelector instanceof DebugElement) {
            return directiveOrSelector;
        }
        else {
            return debugElement.query(By.directive(directiveOrSelector));
        }
    }
    getRootDebugElement() {
        let element = this.debugElement;
        /**
         * This bounded loop call is required to access the debug element for
         * root dom element
         */
        while (true) {
            if (!element) {
                throw Error('Unable to find root element');
            }
            if (!element.parent) {
                // Found the root element
                return element;
            }
            element = element.parent;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLXNwZWN0YXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NwZWN0YXRvci9zcmMvbGliL2Jhc2UvZG9tLXNwZWN0YXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBc0IsTUFBTSxlQUFlLENBQUM7QUFDaEcsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsQyxPQUFPLEVBQW9CLElBQUksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUcvQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDL0MsT0FBTyxFQUFFLFFBQVEsRUFBbUcsTUFBTSxVQUFVLENBQUM7QUFFckksT0FBTyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUscUJBQXFCLEVBQUUsa0JBQWtCLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN0SCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWhELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVqRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUM7QUFFdkI7O0dBRUc7QUFDSCxNQUFNLE9BQWdCLFlBQWdCLFNBQVEsYUFBYTtJQUN6RCxZQUFtQixPQUE4QixFQUFTLFlBQTBCLEVBQVksUUFBVyxF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QUMsQ0FBQztTQUN4RDthQUFNLElBQUksbUJBQW1CLFlBQVksWUFBWSxFQUFFO1lBQ3RELE9BQU8sbUJBQW1CLENBQUM7U0FDNUI7YUFBTTtZQUNMLE9BQU8sWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztTQUM5RDtJQUNILENBQUM7SUFFTyxtQkFBbUI7UUFDekIsSUFBSSxPQUFPLEdBQW9DLElBQUksQ0FBQyxZQUFZLENBQUM7UUFFakU7OztXQUdHO1FBQ0gsT0FBTyxJQUFJLEVBQUU7WUFDWCxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUNaLE1BQU0sS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7YUFDNUM7WUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtnQkFDbkIseUJBQXlCO2dCQUN6QixPQUFPLE9BQU8sQ0FBQzthQUNoQjtZQUVELE9BQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1NBQzFCO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYsIERlYnVnRWxlbWVudCwgRWxlbWVudFJlZiwgVHlwZSwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDb21wb25lbnRGaXh0dXJlLCB0aWNrIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS90ZXN0aW5nJztcbmltcG9ydCB7IEJ5IH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5cbmltcG9ydCB7IFRva2VuIH0gZnJvbSAnLi4vdG9rZW4nO1xuaW1wb3J0IHsgRE9NU2VsZWN0b3IgfSBmcm9tICcuLi9kb20tc2VsZWN0b3JzJztcbmltcG9ydCB7IGlzU3RyaW5nLCBRdWVyeU9wdGlvbnMsIFF1ZXJ5VHlwZSwgU3BlY3RhdG9yRWxlbWVudCwgRXZlbnRFbWl0dGVyVHlwZSwgS2V5c01hdGNoaW5nLCBLZXlib2FyZEV2ZW50T3B0aW9ucyB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IFNweU9iamVjdCB9IGZyb20gJy4uL21vY2snO1xuaW1wb3J0IHsgZ2V0Q2hpbGRyZW4sIHNldFByb3BzIH0gZnJvbSAnLi4vaW50ZXJuYWxzL3F1ZXJ5JztcbmltcG9ydCB7IHBhdGNoRWxlbWVudEZvY3VzIH0gZnJvbSAnLi4vaW50ZXJuYWxzL2VsZW1lbnQtZm9jdXMnO1xuaW1wb3J0IHsgY3JlYXRlTW91c2VFdmVudCB9IGZyb20gJy4uL2V2ZW50LWNyZWF0b3JzJztcbmltcG9ydCB7IGRpc3BhdGNoRmFrZUV2ZW50LCBkaXNwYXRjaEtleWJvYXJkRXZlbnQsIGRpc3BhdGNoTW91c2VFdmVudCwgZGlzcGF0Y2hUb3VjaEV2ZW50IH0gZnJvbSAnLi4vZGlzcGF0Y2gtZXZlbnRzJztcbmltcG9ydCB7IHR5cGVJbkVsZW1lbnQgfSBmcm9tICcuLi90eXBlLWluLWVsZW1lbnQnO1xuaW1wb3J0IHsgc2VsZWN0T3B0aW9uIH0gZnJvbSAnLi4vc2VsZWN0LW9wdGlvbic7XG5cbmltcG9ydCB7IEJhc2VTcGVjdGF0b3IgfSBmcm9tICcuL2Jhc2Utc3BlY3RhdG9yJztcblxuY29uc3QgS0VZX1VQID0gJ2tleXVwJztcblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIERvbVNwZWN0YXRvcjxJPiBleHRlbmRzIEJhc2VTcGVjdGF0b3Ige1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgZml4dHVyZTogQ29tcG9uZW50Rml4dHVyZTxhbnk+LCBwdWJsaWMgZGVidWdFbGVtZW50OiBEZWJ1Z0VsZW1lbnQsIHByb3RlY3RlZCBpbnN0YW5jZTogSSwgcHVibGljIGVsZW1lbnQ6IEVsZW1lbnQpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVibGljIGluamVjdDxUPih0b2tlbjogVG9rZW48VD4pOiBTcHlPYmplY3Q8VD4ge1xuICAgIHJldHVybiBzdXBlci5pbmplY3QodG9rZW4pO1xuICB9XG5cbiAgcHVibGljIGRldGVjdENoYW5nZXMoKTogdm9pZCB7XG4gICAgdGhpcy5maXh0dXJlLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBxdWVyeTxSIGV4dGVuZHMgRWxlbWVudD4oc2VsZWN0b3I6IHN0cmluZyB8IERPTVNlbGVjdG9yLCBvcHRpb25zPzogeyByb290OiBib29sZWFuIH0pOiBSIHwgbnVsbDtcbiAgcHVibGljIHF1ZXJ5PFI+KGRpcmVjdGl2ZTogVHlwZTxSPik6IFIgfCBudWxsO1xuICBwdWJsaWMgcXVlcnk8Uj4oZGlyZWN0aXZlT3JTZWxlY3RvcjogVHlwZTxhbnk+IHwgc3RyaW5nLCBvcHRpb25zOiB7IHJlYWQ6IFRva2VuPFI+IH0pOiBSIHwgbnVsbDtcbiAgcHVibGljIHF1ZXJ5PFI+KGRpcmVjdGl2ZU9yU2VsZWN0b3I6IFF1ZXJ5VHlwZSwgb3B0aW9ucz86IFF1ZXJ5T3B0aW9uczxSPik6IFIgfCBFbGVtZW50IHwgbnVsbCB7XG4gICAgaWYgKChvcHRpb25zIHx8IHt9KS5yb290KSB7XG4gICAgICBpZiAoaXNTdHJpbmcoZGlyZWN0aXZlT3JTZWxlY3RvcikpIHtcbiAgICAgICAgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoZGlyZWN0aXZlT3JTZWxlY3Rvcik7XG4gICAgICB9XG5cbiAgICAgIGlmIChkaXJlY3RpdmVPclNlbGVjdG9yIGluc3RhbmNlb2YgRE9NU2VsZWN0b3IpIHtcbiAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZU9yU2VsZWN0b3IuZXhlY3V0ZShkb2N1bWVudCBhcyBhbnkpWzBdIHx8IG51bGw7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGdldENoaWxkcmVuPFI+KHRoaXMuZGVidWdFbGVtZW50KShkaXJlY3RpdmVPclNlbGVjdG9yLCBvcHRpb25zKVswXSB8fCBudWxsO1xuICB9XG5cbiAgcHVibGljIHF1ZXJ5QWxsPFIgZXh0ZW5kcyBFbGVtZW50PihzZWxlY3Rvcjogc3RyaW5nIHwgRE9NU2VsZWN0b3IsIG9wdGlvbnM/OiB7IHJvb3Q6IGJvb2xlYW4gfSk6IFJbXTtcbiAgcHVibGljIHF1ZXJ5QWxsPFI+KGRpcmVjdGl2ZTogVHlwZTxSPik6IFJbXTtcbiAgcHVibGljIHF1ZXJ5QWxsPFI+KGRpcmVjdGl2ZU9yU2VsZWN0b3I6IFR5cGU8YW55PiB8IHN0cmluZywgb3B0aW9uczogeyByZWFkOiBUb2tlbjxSPiB9KTogUltdO1xuICBwdWJsaWMgcXVlcnlBbGw8Uj4oZGlyZWN0aXZlT3JTZWxlY3RvcjogUXVlcnlUeXBlLCBvcHRpb25zPzogUXVlcnlPcHRpb25zPFI+KTogUltdIHwgRWxlbWVudFtdIHtcbiAgICBpZiAoKG9wdGlvbnMgfHwge30pLnJvb3QpIHtcbiAgICAgIGlmIChpc1N0cmluZyhkaXJlY3RpdmVPclNlbGVjdG9yKSkge1xuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGRpcmVjdGl2ZU9yU2VsZWN0b3IgaW5zdGFuY2VvZiBET01TZWxlY3Rvcikge1xuICAgICAgICByZXR1cm4gZGlyZWN0aXZlT3JTZWxlY3Rvci5leGVjdXRlKGRvY3VtZW50IGFzIGFueSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGdldENoaWxkcmVuPFI+KHRoaXMuZGVidWdFbGVtZW50KShkaXJlY3RpdmVPclNlbGVjdG9yLCBvcHRpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBxdWVyeUxhc3Q8UiBleHRlbmRzIEVsZW1lbnQ+KHNlbGVjdG9yOiBzdHJpbmcgfCBET01TZWxlY3Rvciwgb3B0aW9ucz86IHsgcm9vdDogYm9vbGVhbiB9KTogUiB8IG51bGw7XG4gIHB1YmxpYyBxdWVyeUxhc3Q8Uj4oZGlyZWN0aXZlOiBUeXBlPFI+KTogUiB8IG51bGw7XG4gIHB1YmxpYyBxdWVyeUxhc3Q8Uj4oZGlyZWN0aXZlT3JTZWxlY3RvcjogVHlwZTxhbnk+IHwgc3RyaW5nLCBvcHRpb25zOiB7IHJlYWQ6IFRva2VuPFI+IH0pOiBSIHwgbnVsbDtcbiAgcHVibGljIHF1ZXJ5TGFzdDxSPihkaXJlY3RpdmVPclNlbGVjdG9yOiBRdWVyeVR5cGUsIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnM8Uj4pOiBSIHwgRWxlbWVudCB8IG51bGwge1xuICAgIGxldCByZXN1bHQ6IChSIHwgRWxlbWVudClbXSA9IFtdO1xuXG4gICAgaWYgKChvcHRpb25zIHx8IHt9KS5yb290KSB7XG4gICAgICBpZiAoaXNTdHJpbmcoZGlyZWN0aXZlT3JTZWxlY3RvcikpIHtcbiAgICAgICAgcmVzdWx0ID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGRpcmVjdGl2ZU9yU2VsZWN0b3IgaW5zdGFuY2VvZiBET01TZWxlY3Rvcikge1xuICAgICAgICByZXN1bHQgPSBkaXJlY3RpdmVPclNlbGVjdG9yLmV4ZWN1dGUoZG9jdW1lbnQgYXMgYW55KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmVzdWx0ID0gZ2V0Q2hpbGRyZW48Uj4odGhpcy5kZWJ1Z0VsZW1lbnQpKGRpcmVjdGl2ZU9yU2VsZWN0b3IsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHJlc3VsdFtyZXN1bHQubGVuZ3RoIC0gMV07XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwdWJsaWMgc2V0SW5wdXQ8SyBleHRlbmRzIGtleW9mIEk+KGlucHV0OiBQYXJ0aWFsPEk+KTogdm9pZDtcbiAgcHVibGljIHNldElucHV0PEsgZXh0ZW5kcyBrZXlvZiBJPihpbnB1dDogSywgaW5wdXRWYWx1ZTogSVtLXSk6IHZvaWQ7XG4gIHB1YmxpYyBzZXRJbnB1dChpbnB1dDogYW55LCB2YWx1ZT86IGFueSk6IHZvaWQge1xuICAgIHNldFByb3BzKHRoaXMuaW5zdGFuY2UsIGlucHV0LCB2YWx1ZSwgZmFsc2UpO1xuICAgIHRoaXMuZGVidWdFbGVtZW50LmluamVjdG9yLmdldChDaGFuZ2VEZXRlY3RvclJlZikuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIG91dHB1dDxULCBLIGV4dGVuZHMga2V5b2YgSSA9IGtleW9mIEk+KG91dHB1dDogSyk6IE9ic2VydmFibGU8VD4ge1xuICAgIGNvbnN0IG9ic2VydmFibGUgPSB0aGlzLmluc3RhbmNlW291dHB1dF07XG5cbiAgICBpZiAoIShvYnNlcnZhYmxlIGluc3RhbmNlb2YgT2JzZXJ2YWJsZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHtvdXRwdXR9IGlzIG5vdCBhbiBAT3V0cHV0YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9ic2VydmFibGUgYXMgT2JzZXJ2YWJsZTxUPjtcbiAgfVxuXG4gIHB1YmxpYyB0aWNrKG1pbGxpcz86IG51bWJlcik6IHZvaWQge1xuICAgIHRpY2sobWlsbGlzKTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBjbGljayhzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCk6IHZvaWQge1xuICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpO1xuXG4gICAgaWYgKCEoZWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY2xpY2s6ICR7c2VsZWN0b3J9IGlzIG5vdCBhIEhUTUxFbGVtZW50YCk7XG4gICAgfVxuXG4gICAgZWxlbWVudC5jbGljaygpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIGJsdXIoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQpOiB2b2lkIHtcbiAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKTtcblxuICAgIGlmICghKGVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGJsdXI6ICR7c2VsZWN0b3J9IGlzIG5vdCBhIEhUTUxFbGVtZW50YCk7XG4gICAgfVxuXG4gICAgcGF0Y2hFbGVtZW50Rm9jdXMoZWxlbWVudCk7XG4gICAgZWxlbWVudC5ibHVyKCk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgZm9jdXMoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQpOiB2b2lkIHtcbiAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKTtcblxuICAgIGlmICghKGVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZvY3VzOiAke3NlbGVjdG9yfSBpcyBub3QgYSBIVE1MRWxlbWVudGApO1xuICAgIH1cblxuICAgIHBhdGNoRWxlbWVudEZvY3VzKGVsZW1lbnQpO1xuICAgIGVsZW1lbnQuZm9jdXMoKTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwYXRjaE1vdXNlRXZlbnQoXG4gICAgc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsXG4gICAgdHlwZTogc3RyaW5nLFxuICAgIHg6IG51bWJlciA9IDAsXG4gICAgeTogbnVtYmVyID0gMCxcbiAgICBldmVudDogTW91c2VFdmVudCA9IGNyZWF0ZU1vdXNlRXZlbnQodHlwZSwgeCwgeSlcbiAgKTogTW91c2VFdmVudCB7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3Rvcik7XG5cbiAgICBpZiAoIShlbGVtZW50IGluc3RhbmNlb2YgTm9kZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGRpc3BhdGNoIG1vdXNlIGV2ZW50OiAke3NlbGVjdG9yfSBpcyBub3QgYSBub2RlYCk7XG4gICAgfVxuXG4gICAgY29uc3QgZGlzcGF0Y2hlZEV2ZW50ID0gZGlzcGF0Y2hNb3VzZUV2ZW50KGVsZW1lbnQsIHR5cGUsIHgsIHksIGV2ZW50KTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcblxuICAgIHJldHVybiBkaXNwYXRjaGVkRXZlbnQ7XG4gIH1cblxuICBwdWJsaWMgZGlzcGF0Y2hLZXlib2FyZEV2ZW50KHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50LCB0eXBlOiBzdHJpbmcsIGtleUNvZGU6IG51bWJlciwgdGFyZ2V0PzogRWxlbWVudCk6IEtleWJvYXJkRXZlbnQ7XG4gIHB1YmxpYyBkaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQsIHR5cGU6IHN0cmluZywga2V5OiBzdHJpbmcsIHRhcmdldD86IEVsZW1lbnQpOiBLZXlib2FyZEV2ZW50O1xuICBwdWJsaWMgZGlzcGF0Y2hLZXlib2FyZEV2ZW50KHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50LCB0eXBlOiBzdHJpbmcsIGtleUFuZENvZGU6IEtleWJvYXJkRXZlbnRPcHRpb25zLCB0YXJnZXQ/OiBFbGVtZW50KTogS2V5Ym9hcmRFdmVudDtcbiAgcHVibGljIGRpc3BhdGNoS2V5Ym9hcmRFdmVudChcbiAgICBzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCxcbiAgICB0eXBlOiBzdHJpbmcsXG4gICAga2V5T3JLZXlDb2RlOiBzdHJpbmcgfCBudW1iZXIgfCBLZXlib2FyZEV2ZW50T3B0aW9ucyxcbiAgICB0YXJnZXQ/OiBFbGVtZW50XG4gICk6IEtleWJvYXJkRXZlbnQge1xuICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpO1xuXG4gICAgaWYgKCEoZWxlbWVudCBpbnN0YW5jZW9mIE5vZGUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBkaXNwYXRjaCBrZXlib2FyZCBldmVudDogJHtzZWxlY3Rvcn0gaXMgbm90IGEgbm9kZWApO1xuICAgIH1cblxuICAgIGNvbnN0IGV2ZW50ID0gZGlzcGF0Y2hLZXlib2FyZEV2ZW50KGVsZW1lbnQsIHR5cGUsIGtleU9yS2V5Q29kZSwgdGFyZ2V0KTtcblxuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgcmV0dXJuIGV2ZW50O1xuICB9XG5cbiAgcHVibGljIGRpc3BhdGNoRmFrZUV2ZW50KHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LCB0eXBlOiBzdHJpbmcsIGNhbkJ1YmJsZT86IGJvb2xlYW4pOiBFdmVudCB7XG4gICAgY29uc3QgZXZlbnQgPSBkaXNwYXRjaEZha2VFdmVudCh0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpLCB0eXBlLCBjYW5CdWJibGUpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgcmV0dXJuIGV2ZW50O1xuICB9XG5cbiAgcHVibGljIHRyaWdnZXJFdmVudEhhbmRsZXI8QyA9IGFueSwgSyBleHRlbmRzIEtleXNNYXRjaGluZzxDLCBFdmVudEVtaXR0ZXI8YW55Pj4gPSBhbnk+KFxuICAgIGRpcmVjdGl2ZU9yU2VsZWN0b3I6IFR5cGU8Qz4gfCBzdHJpbmcgfCBEZWJ1Z0VsZW1lbnQsXG4gICAgZXZlbnROYW1lOiBLLFxuICAgIGV2ZW50T2JqOiBFdmVudEVtaXR0ZXJUeXBlPENbS10+LFxuICAgIG9wdGlvbnM/OiB7IHJvb3Q6IGJvb2xlYW4gfVxuICApIHtcbiAgICBjb25zdCB0cmlnZ2VyRGVidWdFbGVtZW50ID0gdGhpcy5nZXRUcmlnZ2VyRGVidWdFbGVtZW50KGRpcmVjdGl2ZU9yU2VsZWN0b3IsIG9wdGlvbnMpO1xuICAgIGlmICghdHJpZ2dlckRlYnVnRWxlbWVudCkge1xuICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqL1xuICAgICAgY29uc29sZS5lcnJvcihgJHtkaXJlY3RpdmVPclNlbGVjdG9yfSBkb2VzIG5vdCBleGlzdHNgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cmlnZ2VyRGVidWdFbGVtZW50LnRyaWdnZXJFdmVudEhhbmRsZXIoZXZlbnROYW1lIGFzIHN0cmluZywgZXZlbnRPYmopO1xuXG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGtleWJvYXJkKCkge1xuICAgIHJldHVybiB7XG4gICAgICBwcmVzc0tleTogKGtleTogc3RyaW5nLCBzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgZXZlbnQgPSBLRVlfVVApID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3IsIGV2ZW50LCBrZXkpO1xuICAgICAgfSxcbiAgICAgIHByZXNzRXNjYXBlOiAoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsIGV2ZW50ID0gS0VZX1VQKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hLZXlib2FyZEV2ZW50KHNlbGVjdG9yLCBldmVudCwgeyBrZXk6ICdFc2NhcGUnLCBrZXlDb2RlOiAyNyB9KTtcbiAgICAgIH0sXG4gICAgICBwcmVzc0VudGVyOiAoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsIGV2ZW50ID0gS0VZX1VQKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hLZXlib2FyZEV2ZW50KHNlbGVjdG9yLCBldmVudCwgeyBrZXk6ICdFbnRlcicsIGtleUNvZGU6IDEzIH0pO1xuICAgICAgfSxcbiAgICAgIHByZXNzVGFiOiAoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsIGV2ZW50ID0gS0VZX1VQKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hLZXlib2FyZEV2ZW50KHNlbGVjdG9yLCBldmVudCwgeyBrZXk6ICdUYWInLCBrZXlDb2RlOiA5IH0pO1xuICAgICAgfSxcbiAgICAgIHByZXNzQmFja3NwYWNlOiAoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsIGV2ZW50ID0gS0VZX1VQKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hLZXlib2FyZEV2ZW50KHNlbGVjdG9yLCBldmVudCwgeyBrZXk6ICdCYWNrc3BhY2UnLCBrZXlDb2RlOiA4IH0pO1xuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGdldCBtb3VzZSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgY29udGV4dG1lbnU6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoTW91c2VFdmVudChzZWxlY3RvciwgJ2NvbnRleHRtZW51Jyk7XG4gICAgICB9LFxuICAgICAgZGJsY2xpY2s6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoTW91c2VFdmVudChzZWxlY3RvciwgJ2RibGNsaWNrJyk7XG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgZGlzcGF0Y2hUb3VjaEV2ZW50KHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LCB0eXBlOiBzdHJpbmcsIHg6IG51bWJlciA9IDAsIHk6IG51bWJlciA9IDApOiB2b2lkIHtcbiAgICBkaXNwYXRjaFRvdWNoRXZlbnQodGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKSwgdHlwZSwgeCwgeSk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgdHlwZUluRWxlbWVudCh2YWx1ZTogc3RyaW5nLCBzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCk6IHZvaWQge1xuICAgIHR5cGVJbkVsZW1lbnQodmFsdWUsIHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3RvcikpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIHNlbGVjdE9wdGlvbihcbiAgICBzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCxcbiAgICBvcHRpb25zOiBzdHJpbmcgfCBzdHJpbmdbXSB8IEhUTUxPcHRpb25FbGVtZW50IHwgSFRNTE9wdGlvbkVsZW1lbnRbXSxcbiAgICBjb25maWc6IHsgZW1pdEV2ZW50czogYm9vbGVhbiB9ID0geyBlbWl0RXZlbnRzOiB0cnVlIH1cbiAgKTogdm9pZCB7XG4gICAgaWYgKCFzZWxlY3Rvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZmluZCBzZWxlY3Q6ICR7c2VsZWN0b3J9YCk7XG4gICAgfVxuICAgIHNlbGVjdE9wdGlvbihvcHRpb25zLCB0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpLCBjb25maWcpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50KTogSFRNTEVsZW1lbnQgfCBXaW5kb3cgfCBEb2N1bWVudCB7XG4gICAgbGV0IGVsZW1lbnQ7XG5cbiAgICAvLyBTdXBwb3J0IGdsb2JhbCBvYmplY3RzIHdpbmRvdyBhbmQgZG9jdW1lbnRcbiAgICBpZiAoc2VsZWN0b3IgPT09IHdpbmRvdyB8fCBzZWxlY3RvciA9PT0gZG9jdW1lbnQpIHtcbiAgICAgIHJldHVybiBzZWxlY3RvciBhcyBhbnk7XG4gICAgfVxuXG4gICAgaWYgKGlzU3RyaW5nKHNlbGVjdG9yKSkge1xuICAgICAgY29uc3QgZXhpc3RzID0gdGhpcy5kZWJ1Z0VsZW1lbnQucXVlcnkoQnkuY3NzKHNlbGVjdG9yKSk7XG4gICAgICBpZiAoZXhpc3RzKSB7XG4gICAgICAgIGVsZW1lbnQgPSBleGlzdHMubmF0aXZlRWxlbWVudDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUgKi9cbiAgICAgICAgY29uc29sZS5lcnJvcihgJHtzZWxlY3Rvcn0gZG9lcyBub3QgZXhpc3RzYCk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChzZWxlY3RvciBpbnN0YW5jZW9mIERPTVNlbGVjdG9yKSB7XG4gICAgICBlbGVtZW50ID0gc2VsZWN0b3IuZXhlY3V0ZShkb2N1bWVudCBhcyBhbnkpWzBdIHx8IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChzZWxlY3RvciBpbnN0YW5jZW9mIERlYnVnRWxlbWVudCB8fCBzZWxlY3RvciBpbnN0YW5jZW9mIEVsZW1lbnRSZWYpIHtcbiAgICAgICAgZWxlbWVudCA9IHNlbGVjdG9yLm5hdGl2ZUVsZW1lbnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBlbGVtZW50ID0gc2VsZWN0b3I7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIGdldFRyaWdnZXJEZWJ1Z0VsZW1lbnQoXG4gICAgZGlyZWN0aXZlT3JTZWxlY3Rvcjogc3RyaW5nIHwgRGVidWdFbGVtZW50IHwgVHlwZTx1bmtub3duPixcbiAgICBvcHRpb25zPzogeyByb290OiBib29sZWFuIH1cbiAgKTogRGVidWdFbGVtZW50IHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBkZWJ1Z0VsZW1lbnQgPSBvcHRpb25zPy5yb290ID8gdGhpcy5nZXRSb290RGVidWdFbGVtZW50KCkgOiB0aGlzLmRlYnVnRWxlbWVudDtcblxuICAgIGlmIChpc1N0cmluZyhkaXJlY3RpdmVPclNlbGVjdG9yKSkge1xuICAgICAgcmV0dXJuIGRlYnVnRWxlbWVudC5xdWVyeShCeS5jc3MoZGlyZWN0aXZlT3JTZWxlY3RvcikpO1xuICAgIH0gZWxzZSBpZiAoZGlyZWN0aXZlT3JTZWxlY3RvciBpbnN0YW5jZW9mIERlYnVnRWxlbWVudCkge1xuICAgICAgcmV0dXJuIGRpcmVjdGl2ZU9yU2VsZWN0b3I7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBkZWJ1Z0VsZW1lbnQucXVlcnkoQnkuZGlyZWN0aXZlKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFJvb3REZWJ1Z0VsZW1lbnQoKTogRGVidWdFbGVtZW50IHtcbiAgICBsZXQgZWxlbWVudDogRGVidWdFbGVtZW50IHwgbnVsbCB8IHVuZGVmaW5lZCA9IHRoaXMuZGVidWdFbGVtZW50O1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBib3VuZGVkIGxvb3AgY2FsbCBpcyByZXF1aXJlZCB0byBhY2Nlc3MgdGhlIGRlYnVnIGVsZW1lbnQgZm9yXG4gICAgICogcm9vdCBkb20gZWxlbWVudFxuICAgICAqL1xuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICBpZiAoIWVsZW1lbnQpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoJ1VuYWJsZSB0byBmaW5kIHJvb3QgZWxlbWVudCcpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWVsZW1lbnQucGFyZW50KSB7XG4gICAgICAgIC8vIEZvdW5kIHRoZSByb290IGVsZW1lbnRcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgICB9XG5cbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==